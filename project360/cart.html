<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Shopping Cart</title>
  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <!-- Bootstrap Icons -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
  />
  <!-- Custom CSS -->
  <link rel="stylesheet" href="cart.css" />
</head>
<body>
  <!-- Optional Header -->
  <div id="loginheader"></div>

  <div class="container mt-4">
    <!-- Breadcrumb -->
    <nav class="breadcrumb mb-4">
      <a class="breadcrumb-item text-decoration-none text-muted" href="#">Home</a>
      <span class="breadcrumb-item active" aria-current="page">Cart</span>
    </nav>

    <div class="row gy-4">
      <!-- Left Section: Cart Table and Actions -->
      <div class="col-lg-8">
        <!-- Cart Table -->
        <div class="table-responsive shadow-sm rounded bg-white p-3">
          <table class="table table-borderless align-middle cart-table mb-0">
            <thead class="border-bottom">
              <tr class="text-uppercase text-muted small">
                <th class="fw-semibold">Remove</th>
                <th class="fw-semibold">Product</th>
                <th class="fw-semibold">Price</th>
                <th class="fw-semibold">Quantity</th>
                <th class="fw-semibold">Subtotal</th>
              </tr>
              <tbody id="cartBody">
                <tr>
                  <td><button class="btn btn-sm btn-outline-danger remove-item">&times;</button></td>
                  <td>Sample Product</td>
                  <td class="product-price">$50</td>
                  <td>
                    <select class="form-select quantity-select">
                      <option value="1">1</option>
                      <option value="2">2</option>
                      <option value="3">3</option>
                      <option value="4">4</option>
                      <option value="5">5</option>
                    </select>
                  </td>
                  <td class="subtotal">$50</td>
                </tr>
              </tbody>
          </table>
        </div>

        <!-- Cart Buttons -->
        <div class="mt-3 d-flex flex-wrap justify-content-center justify-content-md-between">
          <button class="btn btn-outline-dark mb-2">Return To Shop</button>
        </div>

        <!-- Coupon Section -->
        <div class="mt-5 mb-2 mb-md-5 d-flex flex-wrap align-items-center gap-2">
          <input
            type="text"
            class="form-control flex-grow-1"
            placeholder="Coupon Code"
            id="couponCodeInput"
          />
          <button class="btn btn-danger" id="applyCouponBtn">Apply Coupon</button>
        </div>
      </div>

      <!-- Right Section: Cart Total -->
      <div class="col-lg-4">
        <div class="bg-white p-4 rounded shadow-sm">
          <h5 class="fw-bold mb-3">Cart Total</h5>
          <!-- Subtotal -->
          <div class="d-flex justify-content-between mb-2">
            <span>Subtotal:</span>
            <span class="fw-semibold" id="cartSubtotal">$1750</span>
          </div>
          <!-- Shipping -->
          <div class="d-flex justify-content-between mb-2">
            <span>Shipping:</span>
            <span class="fw-semibold">Free</span>
          </div>
          <hr />
          <!-- Total -->
          <div class="d-flex justify-content-between mb-3">
            <span>Total:</span>
            <span class="fw-semibold" id="cartTotal">$1750</span>
          </div>
          <button class="btn btn-danger w-100">
            Proceed to Checkout
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Optional Footer -->
  <div id="footer"></div>

  <!-- Your custom JS to load header/footer if needed -->
  <script src="hfload.js"></script>

  <!-- Bootstrap Bundle (JS) -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
  ></script>

  <!-- Main Cart Script -->
  <script>
    let couponUsed = false;

    // Combined cart update function
    function updateCart() {
        const cartRows = document.querySelectorAll(".cart-table tbody tr");
        let originalTotal = 0;

        cartRows.forEach((row) => {
            if (!row.isConnected) return;

            const priceCell = row.querySelector(".cart-price");
            const basePrice = parseFloat(priceCell.dataset.price);
            const quantitySelect = row.querySelector(".cart-quantity");
            const quantity = parseInt(quantitySelect.value);
            const rowSubtotal = basePrice * quantity;

            row.querySelector(".cart-subtotal").textContent = "$" + rowSubtotal;
            originalTotal += rowSubtotal;
        });

        const finalTotal = couponUsed ? originalTotal / 2 : originalTotal;
        const formatTotal = (amount) => `$$${amount.toFixed(2)}`;

        // Update displays
        const cartSubtotalEl = document.getElementById("cartSubtotal");
        const cartTotalEl = document.getElementById("cartTotal");
        
        if (couponUsed) {
            const strikeThrough = (amount) => `<span style="text-decoration: line-through; color:red;">$$${amount.toFixed(2)}</span>`;
            cartSubtotalEl.innerHTML = `${strikeThrough(originalTotal)} ${formatTotal(finalTotal)}`;
            cartTotalEl.innerHTML = `${strikeThrough(originalTotal)} ${formatTotal(finalTotal)}`;
        } else {
            cartSubtotalEl.textContent = formatTotal(originalTotal);
            cartTotalEl.textContent = formatTotal(originalTotal);
        }
    }

    // Combined coupon handling
    function applyCoupon() {
        const couponInput = document.getElementById("couponCodeInput").value.trim().toUpperCase();
        if (couponInput === "MONHALF") {
            couponUsed = true;
            alert("Coupon MONHALF applied! Prices reduced by half.");
        } else {
            alert("Invalid coupon code!");
        }
        updateCart();
    }

    // Unified cart count updater
    function updateCartCount() {
    const cart = JSON.parse(localStorage.getItem("cart")) || [];
    const totalQuantity = cart.reduce((sum, item) => sum + item.quantity, 0);
    
    // Get both desktop and mobile badges
    const badges = document.querySelectorAll("#cartCountBadge, #cartCountBadgeMobile");
    
    // If badges not found, retry after short delay
    if (badges.length === 0) {
        setTimeout(updateCartCount, 100);
        return;
    }

    badges.forEach(badge => {
        if (totalQuantity > 0) {
            badge.textContent = totalQuantity;
            badge.style.display = "inline-block";
        } else {
            badge.style.display = "none";
        }
    });
}

    // Consolidated cart loader
    function loadCart() {
        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        const cartBody = document.getElementById("cartBody");
        cartBody.innerHTML = "";

        if (cart.length === 0) {
            cartBody.innerHTML = `<tr><td colspan="5" class="text-center">Your cart is empty.</td></tr>`;
            updateCartCount();
            return;
        }

        let totalPrice = 0;
        cart.forEach((product, index) => {
            const subtotal = product.price * product.quantity;
            totalPrice += subtotal;

            cartBody.innerHTML += `
                <tr>
                    <td class="text-center">
                        <i class="bi bi-x-circle text-danger fs-5 remove-item" role="button" data-index="${index}"></i>
                    </td>
                    <td class="d-flex align-items-center">
                        <img src="${product.image}" alt="${product.name}" class="cart-img" />
                        <span class="ms-2">${product.name}</span>
                    </td>
                    <td class="cart-price" data-price="${product.price}">$${product.price}</td>
                    <td style="max-width: 80px;">
                        <select class="form-select cart-quantity" data-index="${index}">
                            ${[1, 2, 3].map(q => `<option ${product.quantity === q ? "selected" : ""}>${q}</option>`).join('')}
                            ${product.quantity > 3 ? `<option selected>${product.quantity}</option>` : ''}
                        </select>
                    </td>
                    <td class="cart-subtotal">$${subtotal.toFixed(2)}</td>
                </tr>`;
        });

        // Event listeners for dynamic elements
        cartBody.querySelectorAll(".remove-item").forEach(button => {
            button.addEventListener("click", removeItem);
        });

        cartBody.querySelectorAll(".cart-quantity").forEach(select => {
            select.addEventListener("change", updateQuantity);
        });

        updateCart();
        updateCartCount();
    }

    // Item management functions
    function removeItem(event) {
        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        cart.splice(event.target.dataset.index, 1);
        localStorage.setItem("cart", JSON.stringify(cart));
        loadCart();
    }

    function updateQuantity(event) {
        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        const index = event.target.dataset.index;
        cart[index].quantity = parseInt(event.target.value);
        localStorage.setItem("cart", JSON.stringify(cart));
        loadCart();
    }

    // Initial setup
    document.addEventListener("DOMContentLoaded", () => {
        // Static event listeners
        document.getElementById("updateCartBtn")?.addEventListener("click", updateCart);
        document.getElementById("applyCouponBtn").addEventListener("click", applyCoupon);
        document.getElementById("buyNowBtn")?.addEventListener("click", addToCart);

        // Initial load
        loadCart();
    });

    // Simplified add to cart function
    function addToCart() {
        const product = {
            name: "Havic HV G-92 Gamepad",
            price: parseFloat(document.getElementById("productPrice").textContent.replace("$", "")), 
            quantity: parseInt(document.getElementById("quantityInput").value),
            image: "havit.jpg"
        };

        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        const existingProduct = cart.find(item => item.name === product.name);

        if (existingProduct) {
            existingProduct.quantity += product.quantity;
        } else {
            cart.push(product);
        }

        localStorage.setItem("cart", JSON.stringify(cart));
        updateCartCount();
    }
</script>
</body>
</html>
